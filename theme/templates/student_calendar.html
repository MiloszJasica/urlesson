{% extends 'base.html' %}
{% block content %}
<div class="px-32 py-8">
  <div class="mb-8 border-b border-gray-600">
    <p class="flex text-5xl font-bold mb-4 justify-center">My Lessons</p>
  </div>
  <div id="calendar"></div>
</div>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet'/>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

<div id="lesson-action-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-gray-700 p-6 w-[400px] rounded-lg shadow-lg flex flex-col">
    <h2 class="text-2xl font-bold mb-4 text-white" id="modal-title">Lesson Action</h2>
    <p id="modal-info" class="mb-6 text-gray-300"></p>

    <div class="flex justify-center space-x-4">
      <button id="cancel" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Cancel Lesson</button>
      <button id="close-modal" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">Close</button>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');
  const csrftoken = "{{ csrf_token }}";
  const modal = document.getElementById('lesson-action-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalInfo = document.getElementById('modal-info');
  const closeModalBtn = document.getElementById('close-modal');
  const cancelBtn = document.getElementById('cancel');
  let currentLessonId = null;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    allDaySlot: false,
    height: 'auto',
    scrollTime: '08:00:00',
    slotMinTime: '06:00:00',
    slotMaxTime: '22:00:00',
    timeZone: 'UTC',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    events: "{% url 'student_calendar_json' %}",

    eventClick: function (info) {
      const type = info.event.extendedProps.type;
      const status = info.event.extendedProps.status;
      
      currentLessonId = info.event.id.replace("lesson-", "");

      if (type === "lesson" && status === "pending") {
        modalTitle.textContent = "Cancel Pending Lesson";
        modalInfo.textContent = `Do you want to cancel your pending lesson ${info.event.title}?`;
        modal.classList.remove('hidden');
      } else {
        modalTitle.textContent = "Lesson Info";
        modalInfo.textContent = "You cannot cancel this lesson because itâ€™s already accepted.";
        cancelBtn.classList.add("hidden");
        modal.classList.remove('hidden');
      }

    }
  });

  calendar.render();

  closeModalBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
    cancelBtn.classList.remove("hidden");
  });

  cancelBtn.addEventListener('click', () => {
    if (!currentLessonId) return;
    fetch("{% url 'update_lesson_status_student' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify({
        id: currentLessonId,
        action: "cancel"
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        modal.classList.add('hidden');
        cancelBtn.classList.remove("hidden");
        calendar.refetchEvents();
        showToast("Lesson cancelled successfully.", "bg-green-600");
      } else {
        showToast("Could not cancel this lesson.", "bg-red-600");
      }
    });
  });
});
</script>


{% endblock %}
